name: Nightly

on:
  schedule:
    # Run nightly at 03:00 UTC
    - cron: '0 3 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  issues: write
  security-events: write

jobs:
  fuzz:
    name: Fuzz Testing
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        include:
          - package: ./parser
            fuzz: ^FuzzParse$
            time: 2m
          - package: ./parser
            fuzz: ^FuzzParseLine$
            time: 2m
          - package: ./gedcom
            fuzz: ^FuzzParseDate$
            time: 2m

    steps:
    - name: Checkout code
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

    - name: Set up Go
      uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
      with:
        go-version: '1.25'
        cache: true

    - name: Run ${{ matrix.fuzz }}
      run: go test ${{ matrix.package }} -fuzz=${{ matrix.fuzz }} -fuzztime=${{ matrix.time }}

    - name: Upload crash artifacts
      if: failure()
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: fuzz-corpus-${{ matrix.fuzz }}
        path: '**/testdata/fuzz/**'
        retention-days: 30

  security:
    name: Security Scan (Nightly)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
      with:
        egress-policy: audit

    - name: Checkout code
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      with:
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
      with:
        go-version: '1.25'

    - name: Run govulncheck
      run: |
        go install golang.org/x/vuln/cmd/govulncheck@latest
        govulncheck -format sarif ./... > govulncheck-results.sarif || true
        govulncheck ./...

    - name: Upload govulncheck results
      uses: github/codeql-action/upload-sarif@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2 # v4
      if: success() || failure()
      with:
        sarif_file: govulncheck-results.sarif
        category: govulncheck

    - name: Run gosec
      run: |
        go install github.com/securego/gosec/v2/cmd/gosec@424fc4cd9c82ea0fd6bee9cd49c2db2c3cc0c93f # v2.22.11
        gosec -fmt sarif -out gosec-results.sarif ./...

    - name: Upload gosec results
      uses: github/codeql-action/upload-sarif@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2 # v4
      if: success() || failure()
      with:
        sarif_file: gosec-results.sarif
        category: gosec

    - name: Trivy filesystem scan
      uses: aquasecurity/trivy-action@c1824fd6edce30d7ab345a9989de00bbd46ef284 # 0.34.0
      continue-on-error: true
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH,MEDIUM'

    - name: Upload Trivy results
      uses: github/codeql-action/upload-sarif@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2 # v4
      if: success() || failure()
      with:
        sarif_file: trivy-results.sarif
        category: trivy

  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [fuzz, security]
    if: failure() && github.event_name == 'schedule'
    steps:
    - name: Checkout code
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

    - name: Create issue on failure
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # Check if an open nightly failure issue already exists
        EXISTING=$(gh issue list --label "nightly-failure" --state open --json number --jq '.[0].number')
        if [ -n "$EXISTING" ]; then
          gh issue comment "$EXISTING" --body "Nightly workflow failed again on $(date -u +%Y-%m-%d).

        [View run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          echo "Commented on existing issue #$EXISTING"
          exit 0
        fi

        gh issue create \
          --title "Nightly workflow failure ($(date -u +%Y-%m-%d))" \
          --label "nightly-failure" \
          --body "The nightly workflow failed on $(date -u +%Y-%m-%d).

        **Fuzz testing**: ${{ needs.fuzz.result }}
        **Security scan**: ${{ needs.security.result }}

        [View full run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

        ---
        This issue was created automatically. Close it once the failure is resolved."
