#!/bin/bash
# Commit-msg hook for gedcom-go
# Install: make setup
#
# Validates that feat/fix commit types only appear on commits
# that touch library code (what module consumers use).

COMMIT_MSG_FILE="$1"
SUBJECT=$(head -1 "$COMMIT_MSG_FILE")

# Only check feat: and fix: commits (including scoped and breaking variants)
if ! echo "$SUBJECT" | grep -qE '^(feat|fix)(\(.+\))?!?:'; then
  exit 0
fi

# Library packages that constitute the public module
LIB_PATTERN='^(charset|converter|decoder|encoder|gedcom|parser|validator|version)/'

# Get staged files (what's actually being committed)
FILES=$(git diff --cached --name-only)

if ! echo "$FILES" | grep -qE "$LIB_PATTERN"; then
  echo ""
  echo "Error: Commit uses '$( echo "$SUBJECT" | grep -oE '^(feat|fix)' )' type but no library code is staged."
  echo ""
  echo "  feat/fix are reserved for library changes (what users consume)."
  echo "  Use ci, build, docs, refactor, chore, etc. for non-library changes."
  echo ""
  echo "  Library packages: charset, converter, decoder, encoder, gedcom,"
  echo "                    parser, validator, version"
  echo ""
  echo "  Staged files:"
  echo "$FILES" | sed 's/^/    /'
  exit 1
fi
