#!/bin/bash
# Pre-commit hook for gedcom-go
# Install: make setup
# Prerequisites: make install-tools
#
# This hook runs fast checks on commit. Coverage checks run on pre-push.

set -e

echo "Running pre-commit checks..."

# Format code
echo "→ Running gofmt check..."
UNFORMATTED=$(gofmt -l .)
if [ -n "$UNFORMATTED" ]; then
  echo "Error: The following files are not formatted:"
  echo "$UNFORMATTED"
  echo ""
  echo "Please run: gofmt -w ."
  exit 1
fi

# Check go.mod is tidy
echo "→ Checking go.mod..."
cp go.mod go.mod.bak
cp go.sum go.sum.bak 2>/dev/null || true
go mod tidy
if ! diff -q go.mod go.mod.bak > /dev/null 2>&1 || ! diff -q go.sum go.sum.bak > /dev/null 2>&1; then
  echo "Error: go.mod/go.sum not tidy. Changes have been applied."
  echo "Please stage the updated go.mod and go.sum files."
  rm -f go.mod.bak go.sum.bak
  exit 1
fi
rm -f go.mod.bak go.sum.bak

# Run vet
echo "→ Running go vet..."
go vet ./...

# Run linter (assumes golangci-lint is installed via make install-tools)
echo "→ Running golangci-lint..."
# Check common locations for golangci-lint
if command -v golangci-lint &> /dev/null; then
  GOLANGCI_LINT="golangci-lint"
elif [ -x "$HOME/go/bin/golangci-lint" ]; then
  GOLANGCI_LINT="$HOME/go/bin/golangci-lint"
elif [ -x "$(go env GOPATH)/bin/golangci-lint" ]; then
  GOLANGCI_LINT="$(go env GOPATH)/bin/golangci-lint"
else
  echo "Error: golangci-lint not found. Run 'make install-tools' first."
  exit 1
fi
$GOLANGCI_LINT run --timeout=5m

# Run tests (same packages as CI)
echo "→ Running tests..."
go test ./charset ./decoder ./encoder ./gedcom ./parser ./validator ./version

echo ""
echo "✓ Pre-commit checks passed"
echo "  (coverage thresholds checked on push)"
